{% extends "dashboard_base.html" %}
{% load static %}

{% block sidebar_title %}Client Menu{% endblock %}
{% block sidebar_menu %}
<li><a href="{% url 'accounts:client_dashboard' %}">Overview</a></li>
<li><a href="{% url 'accounts:client_today' %}">Todays plan</a></li>
<li><a href="{% url 'accounts:client_programme_library' %}">Programme library</a></li>
<li><a href="{% url 'accounts:client_workout_log' %}">Workout log</a></li>
<li><a href="{% url 'accounts:client_metrics' %}" class="is-active">Body metrics</a></li>
<li><a href="{% url 'accounts:client_check_ins' %}">Check-ins</a></li>
<li><a href="{% url 'accounts:client_documents' %}">Documents</a></li>
<li><a href="{% url 'accounts:client_support' %}">Support</a></li>
{% endblock %}

{% block page_eyebrow %}Client dashboard{% endblock %}
{% block page_title %}Body metrics{% endblock %}

{% block dashboard_content %}

<!-- Trend placeholders -->
<section class="dashboard-card dashboard-card--wide">
    <div class="metrics-trend-grid">
        <div class="metrics-trend-card">
            <h2 class="card-title">Bodyweight trend</h2>
            <p class="card-subtitle">
                Weekly bodyweight pattern based on check-ins.
            </p>
            <div class="card-body">
                <div class="metrics-chart">
                    <canvas id="bodyweightChart" aria-label="Bodyweight trend chart"></canvas>
                </div>
                {% if not has_bodyweight_data %}
                    <p class="empty-state">
                        No bodyweight entries recorded yet. Add a body metrics check-in to see a trend.
                    </p>
                {% endif %}
            </div>
        </div>
        <div class="metrics-trend-card">
            <h2 class="card-title">Strength trend</h2>
            <p class="card-subtitle">
                Top sets for an example lift (Bench) based on bench top set entries.
            </p>
            <div class="card-body">
                <div class="metrics-chart">
                    <canvas id="strengthChart" aria-label="Strength trend chart"></canvas>
                </div>
                {% if not has_bench_data %}
                    <p class="empty-state">
                        No strength entries recorded yet. Add bench top set data in body metrics check-ins.
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- Add check-in + recent entries -->
<section class="dashboard-card dashboard-card--wide">
    <header class="card-header">
        <h2 class="card-title">Add body metrics check-in</h2>
        <p class="card-subtitle">
            Log the latest measurements for bodyweight, waist, strength, and sleep.
        </p>
    </header>

    <div class="card-body">
        <form method="post" class="metrics-form">
            {% csrf_token %}

            <div class="form-field">
                {{ form.date.label_tag }}
                {{ form.date }}
            </div>

            <div class="metrics-grid">
                <div class="form-field">
                    {{ form.bodyweight_kg.label_tag }}
                    {{ form.bodyweight_kg }}
                </div>
                <div class="form-field">
                    {{ form.waist_cm.label_tag }}
                    {{ form.waist_cm }}
                </div>
                <div class="form-field">
                    {{ form.bench_top_set_kg.label_tag }}
                    {{ form.bench_top_set_kg }}
                </div>
                <div class="form-field">
                    {{ form.sleep_hours.label_tag }}
                    {{ form.sleep_hours }}
                </div>
            </div>

            <div class="form-field">
                {{ form.notes.label_tag }}
                {{ form.notes }}
            </div>

            <button type="submit" class="btn btn-primary">
                Save check-in
            </button>
        </form>
    </div>

    {% if recent_entries %}
    <div class="card-footer">
        <h3 class="card-footer-title">Recent check-ins</h3>
        <table class="dashboard-table table-compact">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Bodyweight (kg)</th>
                    <th>Waist (cm)</th>
                    <th>Bench top set (kg)</th>
                    <th>Sleep (h)</th>
                    <th class="action-cell">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in recent_entries %}
                <tr>
                    <td>{{ entry.date|date:"d M Y" }}</td>
                    <td>{{ entry.bodyweight_kg|default:"—" }}</td>
                    <td>{{ entry.waist_cm|default:"—" }}</td>
                    <td>{{ entry.bench_top_set_kg|default:"—" }}</td>
                    <td>{{ entry.sleep_hours|default:"—" }}</td>
                    <td class="action-cell nowrap">
                        <a
                            href="#"
                            class="text-link js-open-metric"
                            data-entry-id="{{ entry.id }}"
                            data-date="{{ entry.date|date:'Y-m-d' }}"
                            data-bodyweight="{{ entry.bodyweight_kg|default_if_none:'' }}"
                            data-waist="{{ entry.waist_cm|default_if_none:'' }}"
                            data-bench="{{ entry.bench_top_set_kg|default_if_none:'' }}"
                            data-sleep="{{ entry.sleep_hours|default_if_none:'' }}"
                            data-notes="{{ entry.notes|default_if_none:''|escape }}"
                        >
                            Open
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</section>

<!-- Key metrics summary -->
<section class="dashboard-card dashboard-card--wide">
    <header class="card-header">
        <h2 class="card-title">Key metrics</h2>
        <p class="card-subtitle">
            Latest values and approximate change over the last four weeks.
        </p>
    </header>

    <div class="card-body">
        <table class="dashboard-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Latest</th>
                    <th>Change (4 weeks)</th>
                    <th>Target</th>
                </tr>
            </thead>
            <tbody>
                {% for row in summary_rows %}
                <tr>
                    <td>{{ row.label }}</td>
                    <td>
                        {% if row.latest is not None %}
                            {{ row.latest }} {{ row.unit }}
                        {% else %}
                            &mdash;
                        {% endif %}
                    </td>
                    <td>
                        {% if row.change is not None %}
                            {% if row.change > 0 %}+{% endif %}{{ row.change }} {{ row.unit }}
                        {% else %}
                            &mdash;
                        {% endif %}
                    </td>
                    <td>{{ row.target_display }}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <footer class="card-footer text-muted">
            Values are calculated from stored check-ins. Change compares the latest entry
            with one recorded approximately four weeks earlier when available.
        </footer>
    </section>

<div id="metrics-modal-backdrop" class="session-modal-backdrop is-hidden">
    <div class="session-modal">
        <header class="session-modal-header">
            <h2 id="metrics-modal-title">Body metrics entry</h2>
            <button type="button" class="session-modal-close js-close-metric" aria-label="Close">
                ×
            </button>
        </header>

        <form method="post" action="{% url 'accounts:client_metrics' %}" class="session-modal-form">
            {% csrf_token %}
            <input type="hidden" name="entry_id" id="metric-entry-id">
            <input type="hidden" name="action" value="update">

            <div class="session-modal-body">
                <div class="form-field">
                    <label for="metric-date">Date</label>
                    <input type="date" id="metric-date" name="date">
                </div>

                <div class="form-field">
                    <label for="metric-bodyweight">Bodyweight (kg)</label>
                    <input type="number" step="0.1" min="0" id="metric-bodyweight" name="bodyweight_kg">
                </div>

                <div class="form-field">
                    <label for="metric-waist">Waist (cm)</label>
                    <input type="number" step="0.1" min="0" id="metric-waist" name="waist_cm">
                </div>

                <div class="form-field">
                    <label for="metric-bench">Bench top set (kg)</label>
                    <input type="number" step="0.5" min="0" id="metric-bench" name="bench_top_set_kg">
                </div>

                <div class="form-field">
                    <label for="metric-sleep">Sleep (h)</label>
                    <input type="number" step="0.1" min="0" id="metric-sleep" name="sleep_hours">
                </div>

                <div class="form-field">
                    <label for="metric-notes">Notes</label>
                    <textarea id="metric-notes" name="notes" rows="4"></textarea>
                </div>
            </div>

            <footer class="session-modal-footer">
                <button type="button" class="btn-secondary js-close-metric">Cancel</button>
                <button type="submit" class="btn-primary">Save changes</button>
                <button
                    type="submit"
                    class="btn-secondary"
                    name="action"
                    value="delete"
                    onclick="return confirm('Delete this entry?');"
                >
                    Delete
                </button>
            </footer>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<!-- Charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function () {
    const labels = {{ chart_labels_json|default:"[]"|safe }};
    const bodyweightData = {{ bodyweight_series_json|default:"[]"|safe }};
    const benchData = {{ bench_series_json|default:"[]"|safe }};

    function makeLineChart(canvasId, data, labelText) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) {
            return;
        }
        const hasValues = Array.isArray(data) && data.some(v => v !== null);
        if (!hasValues) {
            return;
        }

        new Chart(canvas, {
            type: "line",
            data: {
                labels: labels,
                datasets: [{
                    label: labelText,
                    data: data,
                    tension: 0.35,
                    pointRadius: 3,
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        title: { display: false }
                    },
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });
    }

    if (Array.isArray(labels) && labels.length) {
        makeLineChart("bodyweightChart", bodyweightData, "Bodyweight (kg)");
        makeLineChart("strengthChart", benchData, "Bench top set (kg)");
    }
})();
</script>
<script defer src="{% static 'js/body_metrics_modal.js' %}"></script>
{% endblock %}
