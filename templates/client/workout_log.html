{% extends "dashboard_base.html" %}

{% block page_eyebrow %}Client dashboard{% endblock %}
{% block page_title %}Workout log{% endblock %}

{% block dashboard_content %}

<section class="dashboard-card dashboard-card--wide">
    <h2 class="dashboard-card__title">Recent sessions</h2>
    <p class="dashboard-card__subtitle">
        Latest workouts logged to your account.
    </p>

    <div class="dashboard-table-wrapper">
        <table class="dashboard-table recent-sessions-table">
            <thead>
                <tr>
                    <th>Session</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Notes</th>
                    <th class="action-cell">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for s in sessions %}
                <tr
                    data-session-id="{{ s.id }}"
                    data-session-name="{{ s.name|escape }}"
                    data-session-date="{{ s.date|date:'Y-m-d' }}"
                    data-session-status="{{ s.status|default:'logged'|escape }}"
                    data-session-notes="{{ s.notes|default:''|escape }}"
                >
                    <td class="session-cell">{{ s.name }}</td>
                    <td class="date-cell nowrap">{{ s.date|date:"d/m/Y" }}</td>
                    <td class="nowrap">{{ s.status|default:"Logged"|capfirst }}</td>
                    <td class="notes-cell">
                        {{ s.notes|default_if_none:""|truncatechars:60 }}
                    </td>
                    <td class="action-cell nowrap">
                        <a href="#" class="text-link js-open-session">Open</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5">
                        No workouts logged yet. Once sessions are added, they will
                        appear here.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<section class="dashboard-card dashboard-card--wide">
    <header class="card-header">
        <h2 class="card-title">Session details</h2>
        <p class="card-subtitle">
            Enter the details for a completed workout and submit it to the coach.
        </p>
    </header>

    <div class="card-body">
        {% if available_days %}
        <form method="get" class="form" style="margin-bottom: 1rem;">
            <div class="form-field">
                <label for="day">Session</label>
                <select
                    id="day"
                    name="day"
                    class="form-control"
                    onchange="this.form.submit()"
                >
                    {% for day in available_days %}
                    <option
                        value="{{ day.id }}"
                        {% if programme_day and programme_day.id == day.id %}selected{% endif %}
                    >
                        {{ day.programme_block }} - {{ day.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </form>
        {% endif %}

        <form method="post" class="workout-log-form">
            {% csrf_token %}
            {% if programme_day %}
            <input type="hidden" name="day" value="{{ programme_day.id }}">
            {% endif %}

            <div class="form-grid">
                <div class="form-field">
                    <label for="{{ session_form.date.id_for_label }}">Date</label>
                    {{ session_form.date }}
                </div>
            </div>

            <div class="workout-table">
                <div class="workout-row workout-row--header">
                    <div class="workout-cell workout-cell--exercise">Exercise</div>
                    <div class="workout-cell workout-cell--weight">Weight (kg)</div>
                    <div class="workout-cell workout-cell--target">Target</div>
                    <div class="workout-cell">Set 1</div>
                    <div class="workout-cell">Set 2</div>
                    <div class="workout-cell">Set 3</div>
                </div>

                {% for ex in programme_exercises %}
                <div class="workout-row">
                    <div class="workout-cell workout-cell--exercise">
                        <strong>{{ ex.exercise_name }}</strong>
                    </div>
                    <div class="workout-cell workout-cell--weight">
                        <input
                            type="number"
                            step="0.5"
                            min="0"
                            name="ex_{{ ex.id }}_weight"
                            class="form-control"
                            placeholder="kg"
                        >
                    </div>
                    <div class="workout-cell workout-cell--target">
                        {{ ex.target_sets }} × {{ ex.target_reps }}
                        {% if ex.target_weight_kg %}
                        @ {{ ex.target_weight_kg }} kg
                        {% endif %}
                    </div>
                    <div class="workout-cell">
                        <input
                            type="text"
                            name="ex_{{ ex.id }}_set1"
                            class="form-control"
                        >
                    </div>
                    <div class="workout-cell">
                        <input
                            type="text"
                            name="ex_{{ ex.id }}_set2"
                            class="form-control"
                        >
                    </div>
                    <div class="workout-cell">
                        <input
                            type="text"
                            name="ex_{{ ex.id }}_set3"
                            class="form-control"
                        >
                    </div>
                </div>
                {% empty %}
                <p class="text-muted">No exercises found for this session.</p>
                {% endfor %}
            </div>

            <div class="form-field">
                <label for="{{ session_form.notes.id_for_label }}">
                    Session notes <span class="field-optional">(optional)</span>
                </label>
                {{ session_form.notes }}
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary">
                    Save + submit
                </button>
                <button type="button" class="btn-secondary" disabled>
                    Save draft
                </button>
            </div>
        </form>
    </div>

    <footer class="card-footer text-muted">
        Set details are stored inside the session notes so that the coaching
        team can review the work completed.
    </footer>
</section>

{# Workout session modal #}
<div id="session-modal-backdrop" class="session-modal-backdrop is-hidden">
    <div class="session-modal">
        <header class="session-modal-header">
            <h2 id="session-modal-title">Workout session</h2>
            <button
                type="button"
                class="session-modal-close js-close-session"
                aria-label="Close"
            >
                ×
            </button>
        </header>

        <form
            method="post"
            action="{% url 'accounts:client_workout_edit' %}"
            class="session-modal-form"
        >
            {% csrf_token %}
            <input type="hidden" name="session_id" id="session-id-field">

            <div class="session-modal-body">
                <div class="form-field">
                    <label for="session-name-field">Session name</label>
                    <input
                        type="text"
                        id="session-name-field"
                        name="name"
                        maxlength="100"
                    >
                </div>

                <div class="form-field">
                    <label for="session-status-field">Status</label>
                    <select id="session-status-field" name="status">
                        <option value="logged">Logged</option>
                        <option value="planned">Planned</option>
                        <option value="skipped">Skipped</option>
                    </select>
                </div>

                <div class="form-field">
                    <label for="session-notes-field">Notes / details</label>
                    <textarea
                        id="session-notes-field"
                        name="notes"
                        rows="5"
                    ></textarea>
                    <p class="help-text">
                        This can include a summary of sets, reps, and how the
                        session felt.
                    </p>
                </div>
            </div>

            <footer class="session-modal-footer">
                <button
                    type="button"
                    class="btn-secondary js-close-session"
                >
                    Cancel
                </button>
                <button type="submit" class="btn-primary">
                    Save changes
                </button>
            </footer>
        </form>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const backdrop = document.getElementById("session-modal-backdrop");
    const titleEl = document.getElementById("session-modal-title");
    const idField = document.getElementById("session-id-field");
    const nameField = document.getElementById("session-name-field");
    const statusField = document.getElementById("session-status-field");
    const notesField = document.getElementById("session-notes-field");

    function openModalFromRow(row) {
        const sessionId = row.dataset.sessionId;
        const sessionName = row.dataset.sessionName || "";
        const sessionStatus = row.dataset.sessionStatus || "logged";
        const sessionNotes = row.dataset.sessionNotes || "";

        idField.value = sessionId;
        nameField.value = sessionName;
        statusField.value = sessionStatus;
        notesField.value = sessionNotes;

        titleEl.textContent = sessionName || "Workout session";

        backdrop.classList.remove("is-hidden");
        document.body.classList.add("no-scroll");
    }

    function closeModal() {
        backdrop.classList.add("is-hidden");
        document.body.classList.remove("no-scroll");
    }

    document.querySelectorAll(".js-open-session").forEach(function (btn) {
        btn.addEventListener("click", function (event) {
            event.preventDefault();
            const row = btn.closest("tr");
            if (row) {
                openModalFromRow(row);
            }
        });
    });

    document.querySelectorAll(".js-close-session").forEach(function (btn) {
        btn.addEventListener("click", closeModal);
    });

    backdrop.addEventListener("click", function (event) {
        if (event.target === backdrop) {
            closeModal();
        }
    });

    document.addEventListener("keydown", function (event) {
        if (event.key === "Escape" && !backdrop.classList.contains("is-hidden")) {
            closeModal();
        }
    });
});
</script>

{% endblock %}
