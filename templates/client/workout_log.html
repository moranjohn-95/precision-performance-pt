{% extends "dashboard_base.html" %}

{% block sidebar_title %}
Client Menu
{% endblock %}

{% block sidebar_menu %}
<li><a href="{% url 'accounts:client_dashboard' %}">Overview</a></li>
<li><a href="{% url 'accounts:client_today' %}">Todays plan</a></li>
<li><a href="{% url 'accounts:client_programme_library' %}">Programme library</a></li>
<li><a href="{% url 'accounts:client_workout_log' %}" class="is-active">Workout log</a></li>
<li><a href="{% url 'accounts:client_metrics' %}">Body metrics</a></li>
<li><a href="{% url 'accounts:client_check_ins' %}">Check-ins</a></li>
<li><a href="{% url 'accounts:client_documents' %}">Documents</a></li>
<li><a href="{% url 'accounts:client_support' %}">Support</a></li>
{% endblock %}

{% block page_eyebrow %}Client dashboard{% endblock %}
{% block page_title %}Workout log{% endblock %}

{% block dashboard_content %}

<section class="dashboard-card dashboard-card--wide">
    <h2 class="dashboard-card__title">Recent sessions</h2>
    <p class="dashboard-card__subtitle">
        Latest workouts logged to your account.
    </p>

    <div class="dashboard-table-wrapper">
        <table class="dashboard-table recent-sessions-table">
            <thead>
                <tr>
                    <th>Session</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Notes</th>
                    <th class="action-cell">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for s in sessions %}
                <tr
                    data-session-id="{{ s.id }}"
                    data-session-name="{{ s.name|escape }}"
                    data-session-date="{{ s.date|date:'Y-m-d' }}"
                    data-session-status="{{ s.status|default:'logged'|escape }}"
                    data-session-notes="{{ s.notes|default:''|escape }}"
                >
                    <td class="session-cell">{{ s.name }}</td>
                    <td class="date-cell nowrap">{{ s.date|date:"d/m/Y" }}</td>
                    <td class="nowrap">{{ s.status|default:"Logged"|capfirst }}</td>
                    <td class="notes-cell">{{ s.notes|default_if_none:""|truncatechars:60 }}</td>
                    <td class="action-cell nowrap">
                        <a href="#" class="text-link js-open-session">Open</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5">
                        No workouts logged yet. Once sessions are added, they will appear here.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<section class="dashboard-card dashboard-card--wide">
    <header class="card-header">
        <h2 class="card-title">Session details</h2>
        <p class="card-subtitle">
            Enter the details for a completed workout and submit it to the coach.
        </p>
    </header>

    <div class="card-body">
        <form method="post" class="workout-log-form">
            {% csrf_token %}

            <!-- Summary line: date + session name -->
            <div class="form-grid">
                <div class="form-field">
                    <label for="{{ session_form.date.id_for_label }}">Date</label>
                    {{ session_form.date }}
                </div>

                <div class="form-field">
                    <label for="{{ session_form.name.id_for_label }}">Session name</label>
                    {{ session_form.name }}
                </div>
            </div>

            <!-- Table-style layout for exercises / sets -->
            <div class="workout-table">
                <div class="workout-row workout-row--header">
                    <div class="workout-cell workout-cell--exercise">Exercise</div>
                    <div class="workout-cell workout-cell--target">Target</div>
                    <div class="workout-cell">Set 1</div>
                    <div class="workout-cell">Set 2</div>
                    <div class="workout-cell">Set 3</div>
                </div>

                <!-- Bench Press row -->
                <div class="workout-row">
                    <div class="workout-cell workout-cell--exercise">
                        <strong>Bench Press</strong><br>
                        <span class="text-muted">Main press</span>
                    </div>
                    <div class="workout-cell workout-cell--target">
                        3 × 8
                    </div>
                    <div class="workout-cell">
                        {{ session_form.bench_set1 }}
                    </div>
                    <div class="workout-cell">
                        {{ session_form.bench_set2 }}
                    </div>
                    <div class="workout-cell">
                        {{ session_form.bench_set3 }}
                    </div>
                </div>

                <!-- Seated Row row -->
                <div class="workout-row">
                    <div class="workout-cell workout-cell--exercise">
                        <strong>Seated Row</strong><br>
                        <span class="text-muted">Upper back</span>
                    </div>
                    <div class="workout-cell workout-cell--target">
                        3 × 10
                    </div>
                    <div class="workout-cell">
                        {{ session_form.row_set1 }}
                    </div>
                    <div class="workout-cell">
                        {{ session_form.row_set2 }}
                    </div>
                    <div class="workout-cell">
                        {{ session_form.row_set3 }}
                    </div>
                </div>

                <!-- DB Incline row -->
                <div class="workout-row">
                    <div class="workout-cell workout-cell--exercise">
                        <strong>DB Incline</strong><br>
                        <span class="text-muted">Chest / shoulders</span>
                    </div>
                    <div class="workout-cell workout-cell--target">
                        3 × 12
                    </div>
                    <div class="workout-cell">
                        {{ session_form.incline_set1 }}
                    </div>
                    <div class="workout-cell">
                        {{ session_form.incline_set2 }}
                    </div>
                    <div class="workout-cell">
                        {{ session_form.incline_set3 }}
                    </div>
                </div>
            </div>

            <!-- Notes -->
            <div class="form-field">
                <label for="{{ session_form.notes.id_for_label }}">
                    Session notes <span class="field-optional">(optional)</span>
                </label>
                {{ session_form.notes }}
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary">
                    Save + submit
                </button>
                <button type="button" class="btn-secondary" disabled>
                    Save draft
                </button>
            </div>
        </form>
    </div>

    <footer class="card-footer text-muted">
        Set details are stored inside the session notes so that the coaching team can
        review the work completed.
    </footer>
</section>

{# Workout session modal #}
<div id="session-modal-backdrop" class="session-modal-backdrop is-hidden">
    <div class="session-modal">
        <header class="session-modal-header">
            <h2 id="session-modal-title">Workout session</h2>
            <button type="button" class="session-modal-close js-close-session" aria-label="Close">
                ×
            </button>
        </header>

        <form
            method="post"
            action="{% url 'accounts:client_workout_edit' %}"
            class="session-modal-form"
        >
            {% csrf_token %}
            <input type="hidden" name="session_id" id="session-id-field">

            <div class="session-modal-body">
                <div class="form-field">
                    <label for="session-name-field">Session name</label>
                    <input
                        type="text"
                        id="session-name-field"
                        name="name"
                        maxlength="100"
                    >
                </div>

                <div class="form-field">
                    <label for="session-status-field">Status</label>
                    <select id="session-status-field" name="status">
                        <option value="logged">Logged</option>
                        <option value="planned">Planned</option>
                        <option value="skipped">Skipped</option>
                    </select>
                </div>

                <div class="form-field">
                    <label for="session-notes-field">Notes / details</label>
                    <textarea
                        id="session-notes-field"
                        name="notes"
                        rows="5"
                    ></textarea>
                    <p class="help-text">
                        This can include a summary of sets, reps, and how the session felt.
                    </p>
                </div>
            </div>

            <footer class="session-modal-footer">
                <button
                    type="button"
                    class="btn-secondary js-close-session"
                >
                    Cancel
                </button>
                <button type="submit" class="btn-primary">
                    Save changes
                </button>
            </footer>
        </form>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const backdrop = document.getElementById("session-modal-backdrop");
    const titleEl = document.getElementById("session-modal-title");
    const idField = document.getElementById("session-id-field");
    const nameField = document.getElementById("session-name-field");
    const statusField = document.getElementById("session-status-field");
    const notesField = document.getElementById("session-notes-field");

    function openModalFromRow(row) {
        const sessionId = row.dataset.sessionId;
        const sessionName = row.dataset.sessionName || "";
        const sessionStatus = row.dataset.sessionStatus || "logged";
        const sessionNotes = row.dataset.sessionNotes || "";

        idField.value = sessionId;
        nameField.value = sessionName;
        statusField.value = sessionStatus;
        notesField.value = sessionNotes;

        titleEl.textContent = sessionName || "Workout session";

        backdrop.classList.remove("is-hidden");
        document.body.classList.add("no-scroll");
    }

    function closeModal() {
        backdrop.classList.add("is-hidden");
        document.body.classList.remove("no-scroll");
    }

    // Open handlers
    document.querySelectorAll(".js-open-session").forEach(function (btn) {
        btn.addEventListener("click", function (event) {
            event.preventDefault();
            const row = btn.closest("tr");
            if (row) {
                openModalFromRow(row);
            }
        });
    });

    // Close handlers
    document.querySelectorAll(".js-close-session").forEach(function (btn) {
        btn.addEventListener("click", closeModal);
    });

    backdrop.addEventListener("click", function (event) {
        if (event.target === backdrop) {
            closeModal();
        }
    });

    document.addEventListener("keydown", function (event) {
        if (event.key === "Escape" && !backdrop.classList.contains("is-hidden")) {
            closeModal();
        }
    });
});
</script>

{% endblock %}
