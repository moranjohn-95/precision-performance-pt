{% extends "dashboard_base.html" %}
{% load static %}

{% block page_eyebrow %}Client dashboard{% endblock %}
{% block page_title %}Workout log{% endblock %}

{% block dashboard_content %}

<section class="dashboard-card dashboard-card--wide">
    <h2 class="dashboard-card__title">Recent sessions</h2>
    <p class="dashboard-card__subtitle">
        Latest workouts logged to your account.
    </p>

    <div class="dashboard-table-wrapper">
        <table class="dashboard-table recent-sessions-table">
            <thead>
                <tr>
                    <th>Session</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Notes</th>
                    <th class="action-cell">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for s in sessions %}
                <tr
                    data-session-id="{{ s.id }}"
                    data-session-name="{{ s.name|escape }}"
                    data-session-date="{{ s.date|date:'Y-m-d' }}"
                    data-session-status="{{ s.status|default:'logged'|escape }}"
                    data-session-notes="{{ s.notes|default:''|escape }}"
                >
                    <td class="session-cell">{{ s.name }}</td>
                    <td class="date-cell nowrap">{{ s.date|date:"d/m/Y" }}</td>
                    <td class="nowrap">{{ s.status|default:"Logged"|capfirst }}</td>
                    <td class="notes-cell">
                        {{ s.notes|default_if_none:""|truncatechars:60 }}
                    </td>
                    <td class="action-cell nowrap">
                        <a href="#" class="text-link js-open-session">Open</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5">
                        No workouts logged yet. Once sessions are added, they will
                        appear here.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

{% if sessions.has_other_pages %}
{# Standard paginator: Prev / Page X of Y / Next #}
<nav class="pagination-nav" aria-label="Workout sessions pagination">
    <ul class="pagination">
        {% if sessions.has_previous %}
        <li class="pagination-item">
            <a
                href="?page={{ sessions.previous_page_number }}"
                class="pagination-link"
            >
                &lt; Prev
            </a>
        </li>
        {% endif %}

        <li class="pagination-item is-active">
            <span class="pagination-link">
                Page {{ sessions.number }} of {{ sessions.paginator.num_pages }}
            </span>
        </li>

        {% if sessions.has_next %}
        <li class="pagination-item">
            <a
                href="?page={{ sessions.next_page_number }}"
                class="pagination-link"
            >
                Next &gt;
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}
</section>

<section class="dashboard-card dashboard-card--wide">
    <header class="card-header">
        <h2 class="card-title">Session details</h2>
        <p class="card-subtitle">
            Enter the details for a completed workout and submit it to the coach.
        </p>
    </header>

    <div class="card-body">
        {% if available_days %}
        <form method="get" class="form" style="margin-bottom: 1rem;">
            <div class="form-field">
                <label for="week">Week</label>
                <select
                    id="week"
                    name="week"
                    class="form-control"
                    data-auto-submit
                >
                    {% for w in week_options %}
                    <option
                        value="{{ w }}"
                        {% if selected_week == w %}selected{% endif %}
                    >
                        Week {{ w }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-field">
                <label for="day">Session</label>
                <select
                    id="day"
                    name="day"
                    class="form-control"
                    data-auto-submit
                >
                    {% for day in available_days %}
                    <option
                        value="{{ day.id }}"
                        {% if programme_day and programme_day.id == day.id %}selected{% endif %}
                    >
                        {{ day.programme_block }} - {{ day.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </form>
        {% endif %}

        <form method="post" class="workout-log-form">
            {% csrf_token %}
            {% if programme_day %}
            <input type="hidden" name="day" value="{{ programme_day.id }}">
            {% endif %}
            {% if selected_week %}
            <input type="hidden" name="week" value="{{ selected_week }}">
            {% endif %}

            <div class="form-grid">
                <div class="form-field">
                    <label for="{{ session_form.date.id_for_label }}">Date</label>
                    {{ session_form.date }}
                </div>
            </div>

            <div class="workout-table">
                <div class="workout-row workout-row--header">
                    <div class="workout-cell workout-cell--exercise">Exercise</div>
                    <div class="workout-cell workout-cell--weight">Weight (kg)</div>
                    <div class="workout-cell workout-cell--target">Target</div>
                    <div class="workout-cell workout-cell--performed">Sets × reps</div>
                </div>

                {% for ex in programme_exercises %}
                <div
                    class="workout-row"
                    data-ex-id="{{ ex.id }}"
                    data-target-sets="{{ ex.target_sets }}"
                    data-target-reps="{{ ex.target_reps }}"
                    data-target-weight="{{ ex.target_weight_kg|default_if_none:'' }}"
                >
                    <div class="workout-cell workout-cell--exercise">
                        <strong>{{ ex.exercise_name }}</strong>
                    </div>
                    <div class="workout-cell workout-cell--weight">
                        <input
                            type="number"
                            step="0.5"
                            min="0"
                            name="ex_{{ ex.id }}_weight"
                            class="form-control"
                            placeholder="kg"
                            aria-label="Weight (kg) for {{ ex.exercise_name }}"
                        >
                    </div>
                    <div class="workout-cell workout-cell--target">
                        {{ ex.target_sets }} × {{ ex.target_reps }}
                        {% if ex.target_weight_kg %}
                        @ {{ ex.target_weight_kg }} kg
                        {% endif %}
                    </div>
                    <div class="workout-cell workout-cell--performed">
                        <input
                            type="text"
                            name="ex_{{ ex.id }}_sets_reps"
                            class="form-control js-sets-reps"
                            placeholder="e.g. 3 x 8"
                            data-ex-id="{{ ex.id }}"
                            aria-label="Sets and reps for {{ ex.exercise_name }}"
                        >
                        {# Keep legacy set fields so existing session summaries still work #}
                        <input type="hidden" name="ex_{{ ex.id }}_set1" class="js-legacy-set" data-ex-id="{{ ex.id }}" data-set="1">
                        <input type="hidden" name="ex_{{ ex.id }}_set2" class="js-legacy-set" data-ex-id="{{ ex.id }}" data-set="2">
                        <input type="hidden" name="ex_{{ ex.id }}_set3" class="js-legacy-set" data-ex-id="{{ ex.id }}" data-set="3">
                    </div>
                </div>
                {% empty %}
                <p class="text-muted">No exercises found for this session.</p>
                {% endfor %}
            </div>

            <div class="form-field">
                <label for="{{ session_form.notes.id_for_label }}">
                    Session notes <span class="field-optional">(optional)</span>
                </label>
                {{ session_form.notes }}
            </div>

            <div class="form-actions" style="margin-bottom: 0.75rem;">
                <button type="submit" class="btn-primary">
                    Save + submit
                </button>
            </div>
        </form>
    </div>

    <footer class="card-footer text-muted">
        Set details are stored inside the session notes so that the coaching
        team can review the work completed.
    </footer>
</section>

{# Workout session modal #}
<div id="session-modal-backdrop" class="session-modal-backdrop is-hidden">
    <div class="session-modal">
        <header class="session-modal-header">
            <h2 id="session-modal-title">Workout session</h2>
            <button
                type="button"
                class="session-modal-close js-close-session"
                aria-label="Close"
            >
                ×
            </button>
        </header>

        <form
            method="post"
            action="{% url 'accounts:client_workout_edit' %}"
            class="session-modal-form"
        >
            {% csrf_token %}
            <input type="hidden" name="session_id" id="session-id-field">

            <div class="session-modal-body">
                <div class="form-field">
                    <label for="session-name-field">Session name</label>
                    <input
                        type="text"
                        id="session-name-field"
                        name="name"
                        maxlength="100"
                    >
                </div>

                <div class="form-field">
                    <label for="session-status-field">Status</label>
                    <select id="session-status-field" name="status">
                        <option value="logged">Logged</option>
                        <option value="planned">Planned</option>
                        <option value="skipped">Skipped</option>
                    </select>
                </div>

                <div class="form-field">
                    <label for="session-notes-field">Notes / details</label>
                    <textarea
                        id="session-notes-field"
                        name="notes"
                        rows="5"
                    ></textarea>
                    <p class="help-text">
                        This can include a summary of sets, reps, and how the
                        session felt.
                    </p>
                </div>
            </div>

            <footer class="session-modal-footer">
                <button
                    type="button"
                    class="btn-danger js-close-session"
                >
                    Cancel
                </button>
                <button type="submit" class="btn-secondary">
                    Save changes
                </button>
            </footer>
        </form>
    </div>
</div>



{% endblock %}

{% block page_scripts %}
<script src="{% static 'js/workout_log.js' %}"></script>
{% endblock %}

