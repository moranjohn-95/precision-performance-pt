{% extends "dashboard_base.html" %}
{% load static %}

{% block sidebar_title %}Trainer Menu{% endblock %}
{% block sidebar_menu %}
{% include "trainer/_sidebar.html" %}
{% endblock %}

{% block page_eyebrow %}Trainer dashboard{% endblock %}
{% block page_title %}Client overview{% endblock %}
{% block page_subtitle %}
<section class="page-context">
  <div class="page-context__inner">
    <div class="page-context__copy">
      <p class="page-context__label">Client</p>
      <p class="page-context__value">{{ client.get_full_name|default:client.username }}</p>
    </div>

    {# Only owners (superusers) can delete clients #}
    {% if request.user.is_superuser %}
      <div class="page-context__actions">
        <form
            method="post"
            action="{% url 'accounts:owner_delete_client' client.id %}"
            style="margin: 0;"
        >
            {% csrf_token %}
            <button
                type="submit"
                class="btn-danger"
                onclick="return confirm('Delete this client and all their data? This cannot be undone.');"
            >
                Delete client
            </button>
        </form>
      </div>
    {% endif %}
  </div>
</section>
{% endblock %}

{% block dashboard_content %}
<section class="dashboard-card dashboard-card--wide">
    <header class="card-header">
        <h2 class="card-title">Recent sessions</h2>
    </header>

    <div class="card-body">
        <div class="dashboard-table-wrapper">
            <table class="dashboard-table">
                <thead>
                    <tr>
                        <th>Session</th>
                        <th>Date</th>
                        <th>Notes</th>
                        <th class="action-cell">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in workouts %}
                    <tr>
                        <td>{{ s.name }}</td>
                        <td>{{ s.date|date:"d/m/Y" }}</td>
                        <td>{{ s.notes|default_if_none:""|truncatechars:60 }}</td>
                        <td class="action-cell nowrap">
                            <a href="{% url 'accounts:trainer_session_edit' s.id %}" class="text-link">
                                Open
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-muted">No sessions recorded yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</section>

<section class="dashboard-card dashboard-card--wide">
    <header class="card-header">
        <h2 class="card-title">Bodyweight trend</h2>
        <p class="card-subtitle">Based on bodyweight check-ins.</p>
    </header>

    <div class="card-body">
        <div class="metrics-chart">
            <canvas id="bodyweightChart"></canvas>
        </div>
        {% if not has_bodyweight_data %}
            <p class="empty-state">No bodyweight entries recorded yet.</p>
        {% endif %}
    </div>
</section>

<section class="dashboard-card dashboard-card--wide">
    <header class="card-header">
        <h2 class="card-title">Strength trend</h2>
        <p class="card-subtitle">Bench top set entries.</p>
    </header>

    <div class="card-body">
        <div class="metrics-chart">
            <canvas id="strengthChart"></canvas>
        </div>
        {% if not has_bench_data %}
            <p class="empty-state">No bench top set data recorded yet.</p>
        {% endif %}
    </div>
</section>

<section class="dashboard-card dashboard-card--wide">
    <header class="card-header">
        <h2 class="card-title">Recent check-ins</h2>
    </header>

    <div class="card-body">
        <div class="dashboard-table-wrapper">
            <table class="dashboard-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Bodyweight (kg)</th>
                        <th>Waist (cm)</th>
                        <th>Bench top set (kg)</th>
                        <th>Sleep (h)</th>
                        <th class="action-cell">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in recent_entries %}
                    <tr>
                        <td>{{ entry.date|date:"d M Y" }}</td>
                        <td>{{ entry.bodyweight_kg|default:"—" }}</td>
                        <td>{{ entry.waist_cm|default:"—" }}</td>
                        <td>{{ entry.bench_top_set_kg|default:"—" }}</td>
                        <td>{{ entry.sleep_hours|default:"—" }}</td>
                        <td class="action-cell nowrap">
                            <a
                                href="#"
                                class="text-link js-open-metric"
                                data-entry-id="{{ entry.id }}"
                                data-date="{{ entry.date|date:'Y-m-d' }}"
                                data-bodyweight="{{ entry.bodyweight_kg|default:'' }}"
                                data-waist="{{ entry.waist_cm|default:'' }}"
                                data-bench="{{ entry.bench_top_set_kg|default:'' }}"
                                data-sleep="{{ entry.sleep_hours|default:'' }}"
                                data-notes="{{ entry.notes|default_if_none:''|escapejs }}"
                            >
                                Open
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-muted">No check-ins recorded yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</section>

<section class="dashboard-card dashboard-card--wide">
    <header class="card-header">
        <h2 class="card-title">Key metrics</h2>
        <p class="card-subtitle">Latest values and change over ~4 weeks.</p>
    </header>

    <div class="card-body">
        <div class="dashboard-table-wrapper">
            <table class="dashboard-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Latest</th>
                        <th>Change (4 weeks)</th>
                        <th>Target</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in summary_rows %}
                    <tr>
                        <td>{{ row.label }}</td>
                        <td>{{ row.latest }}</td>
                        <td>{{ row.change }}</td>
                        <td>{{ row.target }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-muted">No summary data available yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</section>

<div id="metrics-modal-backdrop" class="session-modal-backdrop is-hidden">
    <div class="session-modal">
        <header class="session-modal-header">
            <h2 id="metrics-modal-title">Edit check-in</h2>
            <button type="button" class="session-modal-close js-close-metric" aria-label="Close">
                ×
            </button>
        </header>

        <form method="post" class="session-modal-form">
            {% csrf_token %}
            <input type="hidden" name="entry_id" id="metric-entry-id">
            <input type="hidden" name="action" id="metric-action-field" value="update">

            <div class="session-modal-body">
                <div class="form-field">
                    <label for="metric-date">Date</label>
                    <input type="date" id="metric-date" name="date" required>
                </div>

                <div class="form-grid">
                    <div class="form-field">
                        <label for="metric-bodyweight">Bodyweight (kg)</label>
                        <input type="number" step="0.1" min="0" id="metric-bodyweight" name="bodyweight_kg">
                    </div>
                    <div class="form-field">
                        <label for="metric-waist">Waist (cm)</label>
                        <input type="number" step="0.1" min="0" id="metric-waist" name="waist_cm">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-field">
                        <label for="metric-bench">Bench top set (kg)</label>
                        <input type="number" step="0.5" min="0" id="metric-bench" name="bench_top_set_kg">
                    </div>
                    <div class="form-field">
                        <label for="metric-sleep">Sleep (h)</label>
                        <input type="number" step="0.1" min="0" id="metric-sleep" name="sleep_hours">
                    </div>
                </div>

                <div class="form-field">
                    <label for="metric-notes">Notes</label>
                    <textarea id="metric-notes" name="notes" rows="4"></textarea>
                </div>
            </div>

            <footer class="session-modal-footer">
                <button type="button" class="btn-secondary js-close-metric">
                    Cancel
                </button>
                <button
                    type="submit"
                    class="btn-danger"
                    name="action"
                    value="delete"
                    onclick="return confirm('Delete this check-in?');"
                >
                    Delete
                </button>
                <button type="submit" class="btn-primary">
                    Save changes
                </button>
            </footer>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script id="clientChartData" type="application/json">
  {
    "labels": {{ chart_labels_json|default:"[]"|safe }},
    "bodyweight": {{ bodyweight_series_json|default:"[]"|safe }},
    "bench": {{ bench_series_json|default:"[]"|safe }}
  }
</script>
<script src="{% static 'js/client_detail_charts.js' %}"></script>
<script defer src="{% static 'js/body_metrics_modal.js' %}"></script>
{% endblock %}
