{% extends "dashboard_base.html" %}

{% block sidebar_title %}Trainer Menu{% endblock %}
{% block sidebar_menu %}
{% include "trainer/_sidebar.html" %}
{% endblock %}

{% block page_eyebrow %}Trainer dashboard{% endblock %}
{% block page_title %}Client overview{% endblock %}
{% block page_subtitle %}
Logged in: {{ request.user.get_full_name|default:request.user.username }}
{% endblock %}

{% block dashboard_content %}

<section class="dashboard-card dashboard-card--wide">
    <header class="card-header">
        <h2 class="card-title">Recent sessions</h2>
        <p class="card-subtitle">
            {{ client.get_full_name|default:client.username }}
        </p>
    </header>

    <div class="card-body">
        <div class="dashboard-table-wrapper">
            <table class="dashboard-table">
                <thead>
                    <tr>
                        <th>Session</th>
                        <th>Date</th>
                        <th>Notes</th>
                        <th class="action-cell">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in workouts %}
                    <tr>
                        <td>{{ s.name }}</td>
                        <td>{{ s.date|date:"d/m/Y" }}</td>
                        <td>{{ s.notes|default_if_none:""|truncatechars:60 }}</td>
                        <td class="action-cell nowrap">
                            <a href="{% url 'accounts:trainer_session_edit' s.id %}" class="text-link">
                                Open
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-muted">No sessions recorded yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</section>

<section class="dashboard-card dashboard-card--wide">
    <header class="card-header">
        <h2 class="card-title">Bodyweight trend</h2>
        <p class="card-subtitle">Based on bodyweight check-ins.</p>
    </header>

    <div class="card-body">
        <div class="metrics-chart">
            <canvas id="bodyweightChart"></canvas>
        </div>
        {% if not has_bodyweight_data %}
            <p class="empty-state">No bodyweight entries recorded yet.</p>
        {% endif %}
    </div>
</section>

<section class="dashboard-card dashboard-card--wide">
    <header class="card-header">
        <h2 class="card-title">Strength trend</h2>
        <p class="card-subtitle">Bench top set entries.</p>
    </header>

    <div class="card-body">
        <div class="metrics-chart">
            <canvas id="strengthChart"></canvas>
        </div>
        {% if not has_bench_data %}
            <p class="empty-state">No bench top set data recorded yet.</p>
        {% endif %}
    </div>
</section>

<section class="dashboard-card dashboard-card--wide">
    <header class="card-header">
        <h2 class="card-title">Recent check-ins</h2>
    </header>

    <div class="card-body">
        <div class="dashboard-table-wrapper">
            <table class="dashboard-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Bodyweight (kg)</th>
                        <th>Waist (cm)</th>
                        <th>Bench top set (kg)</th>
                        <th>Sleep (h)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in recent_entries %}
                    <tr>
                        <td>{{ entry.date|date:"d M Y" }}</td>
                        <td>{{ entry.bodyweight_kg|default:"—" }}</td>
                        <td>{{ entry.waist_cm|default:"—" }}</td>
                        <td>{{ entry.bench_top_set_kg|default:"—" }}</td>
                        <td>{{ entry.sleep_hours|default:"—" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-muted">No check-ins recorded yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</section>

<section class="dashboard-card dashboard-card--wide">
    <header class="card-header">
        <h2 class="card-title">Key metrics</h2>
        <p class="card-subtitle">Latest values and change over ~4 weeks.</p>
    </header>

    <div class="card-body">
        <div class="dashboard-table-wrapper">
            <table class="dashboard-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Latest</th>
                        <th>Change (4 weeks)</th>
                        <th>Target</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in summary_rows %}
                    <tr>
                        <td>{{ row.label }}</td>
                        <td>{{ row.latest }}</td>
                        <td>{{ row.change }}</td>
                        <td>{{ row.target }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-muted">No summary data available yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</section>

{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function() {
    const labels = {{ chart_labels_json|default:"[]"|safe }};
    const bodyweightData = {{ bodyweight_series_json|default:"[]"|safe }};
    const benchData = {{ bench_series_json|default:"[]"|safe }};

    function makeLineChart(canvasId, data, labelText) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        const hasValues = Array.isArray(data) && data.some(v => v !== null && v !== undefined);
        if (!hasValues) return;

        new Chart(canvas, {
            type: "line",
            data: {
                labels: labels,
                datasets: [{
                    label: labelText,
                    data: data,
                    tension: 0.35,
                    pointRadius: 3,
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { title: { display: false } },
                    y: { beginAtZero: false },
                }
            }
        });
    }

    if (Array.isArray(labels) && labels.length) {
        makeLineChart("bodyweightChart", bodyweightData, "Bodyweight (kg)");
        makeLineChart("strengthChart", benchData, "Bench top set (kg)");
    }
})();
</script>
{% endblock %}
