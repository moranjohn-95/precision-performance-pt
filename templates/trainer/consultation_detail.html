{% extends "dashboard_base.html" %}

{% block title %}Consultation details | Precision Performance PT{% endblock %}
{% block sidebar_title %}Trainer Menu{% endblock %}
{% block sidebar_menu %}
{% include "trainer/_sidebar.html" %}
{% endblock %}

{% block page_eyebrow %}Trainer dashboard{% endblock %}
{% block page_title %}Consultation details{% endblock %}
{% block page_subtitle %}{% endblock %}

{% block dashboard_content %}
<section class="dashboard-card">
    <header class="card-header">
        <h2 class="card-title">Consultation</h2>
    </header>

    <div class="card-body">
        <div class="dashboard-table-wrapper">
            <table class="dashboard-table">
                <tbody>
                    <tr>
                        <th scope="row">Submitted</th>
                        <td>{{ consultation.created_at|date:"d M Y" }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Name</th>
                        <td>{{ consultation.first_name }} {{ consultation.last_name }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Email</th>
                        <td>{{ consultation.email }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Phone</th>
                        <td>{{ consultation.phone|default:"—" }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Training goal</th>
                        <td>{{ consultation.get_training_goal_display|default:"—" }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Coaching option</th>
                        <td>{{ consultation.get_coaching_option_display|default:"—" }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Preferred date</th>
                        <td>{{ consultation.preferred_date|default:"—" }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Preferred time window</th>
                        <td>{{ consultation.get_preferred_time_window_display|default:"—" }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Availability notes</th>
                        <td>{{ consultation.availability_notes|linebreaksbr }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Training background</th>
                        <td>{{ consultation.training_background|linebreaksbr }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Status</th>
                        <td>{{ consultation.get_status_display|default:"—" }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Assigned trainer</th>
                        <td>
                            {% if consultation.assigned_trainer %}
                                {{ consultation.assigned_trainer.get_full_name|default:consultation.assigned_trainer.username }}
                            {% else %}
                                &mdash;
                            {% endif %}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <footer class="card-footer card-footer--actions">
        <form method="post">
            {% csrf_token %}

            {# Group coaching branch (small or large group) #}
            {% if consultation.coaching_option == "small_group" or consultation.coaching_option == "large_group" %}
                <div class="consultation-actions">
                    {% if consultation.status == consultation.STATUS_ADDED_CLASSES %}
                        <button type="submit" class="btn-secondary" disabled>
                            Already added to classes
                        </button>
                    {% else %}
                        <button
                            type="submit"
                            formaction="{% url 'accounts:trainer_add_to_current_classes' consultation.id %}"
                            class="btn-primary"
                        >
                            Add to classes
                        </button>
                    {% endif %}
                    <a
                        href="{% url 'accounts:trainer_dashboard' %}"
                        class="btn-link"
                    >
                        Back to overview
                    </a>
                </div>
            {% else %}
                {# 1:1 or online branch #}
                {% if consultation.assigned_trainer %}
                    <p class="text-muted">
                        Assigned trainer:
                        {{ consultation.assigned_trainer.get_full_name|default:consultation.assigned_trainer.username }}
                    </p>

                    {% if consultation.assigned_trainer == request.user %}
                        <button type="submit" class="btn-secondary" disabled>
                            Already added to clients
                        </button>
                    {% else %}
                        <button type="submit" class="btn-secondary" disabled>
                            Assigned to another trainer
                        </button>
                    {% endif %}
                {% else %}
                    {% if request.user.is_superuser %}
                        {# Owner assign UI: choose any trainer (including self) then assign #}
                        <div class="form-inline" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <label for="trainer_id" class="visually-hidden">Assign to trainer</label>
                            <select
                                name="trainer_id"
                                id="trainer_id"
                                class="form-control"
                                style="min-width: 220px;"
                                onchange="document.getElementById('assign-client-btn').disabled = !this.value;"
                            >
                                <option value="" selected disabled>Select trainer</option>
                                <option value="{{ request.user.id }}">Me ({{ request.user.username }})</option>
                                {% for t in trainers %}
                                    <option value="{{ t.id }}">
                                        {{ t.get_full_name|default:t.username }}
                                    </option>
                                {% endfor %}
                            </select>
                            <button
                                type="submit"
                                name="assign_to_trainer"
                                class="btn-primary"
                                id="assign-client-btn"
                                disabled
                            >
                                Assign client
                            </button>
                            <a
                                href="{% url 'accounts:trainer_dashboard' %}"
                                class="btn-link"
                                style="align-self: center;"
                            >
                                Back to overview
                            </a>
                        </div>
                    {% else %}
                        {# Trainer self-assign UI #}
                        <button
                            type="submit"
                            name="assign_to_me"
                            class="btn-primary"
                        >
                            Add to my clients
                        </button>
                    {% endif %}
                {% endif %}
            {% endif %}
        </form>
    </footer>
</section>
{% endblock %}
