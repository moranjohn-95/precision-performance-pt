{% extends "dashboard_base.html" %}
{% load static %}

{% block sidebar_title %}Trainer Menu{% endblock %}
{% block sidebar_menu %}
    {% include "trainer/_sidebar.html" %}
{% endblock %}

{% block page_eyebrow %}Trainer dashboard{% endblock %}
{% block page_title %}My clients{% endblock %}
{% block page_subtitle %}{% endblock %}

{% block dashboard_content %}
    {# Section 1: clients added from consultation requests #}
    <div class="dashboard-card">
        <h2 class="dashboard-card__title">Clients added from consultation requests</h2>

        <form method="get" class="table-filter" style="margin: 0 0 1rem;">
        <label for="client-type-filter" class="form-label">Show:</label>
        <select
            id="client-type-filter"
            name="type"
            class="form-control"
            data-auto-submit
        >
            <option value="all" {% if client_type == "all" %}selected{% endif %}>
                All
            </option>
            <option value="online" {% if client_type == "online" %}selected{% endif %}>
                Online
            </option>
            <option value="1to1" {% if client_type == "1to1" %}selected{% endif %}>
                1:1
            </option>
        </select>

        <label for="portal-filter" class="form-label" style="margin-left: 1rem;">Portal access:</label>
        <select
            id="portal-filter"
            name="portal"
            class="form-control"
            data-auto-submit
        >
            <option value="all" {% if portal_filter == "all" %}selected{% endif %}>All</option>
            <option value="yes" {% if portal_filter == "yes" %}selected{% endif %}>Yes</option>
            <option value="no" {% if portal_filter == "no" %}selected{% endif %}>No</option>
        </select>
    </form>

        <div class="dashboard-table-wrapper">
            <table class="dashboard-table clients-table">
                <thead>
                    <tr>
                        <th scope="col" class="col-name">Name</th>
                        <th scope="col" class="col-email">Email</th>
                        <th scope="col" class="col-deal">Goal</th>
                        <th scope="col" class="col-coaching">Coaching option</th>
                        <th scope="col" class="col-last-requested">Last request</th>
                        <th scope="col" class="col-action">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in clients_page %}
                        <tr>
                            <td class="col-name">
                                {% with full_name=req.first_name|add:" "|add:req.last_name %}
                                    {% if req.portal_user_id %}
                                        <a
                                            class="text-link"
                                            href="{% url 'accounts:trainer_client_detail' req.portal_user_id %}"
                                        >
                                            {{ full_name|default:req.email }}
                                        </a>
                                    {% else %}
                                        {{ full_name|default:req.email }}
                                    {% endif %}
                                {% endwith %}
                            </td>
                            <td class="col-email">{{ req.email }}</td>
                            <td class="col-deal">{{ req.get_training_goal_display|default:req.training_goal }}</td>
                            <td class="col-coaching">{{ req.get_coaching_option_display|default:req.coaching_option }}</td>
                            <td class="col-last-requested">{{ req.created_at|date:"d M Y" }}</td>
                            <td class="col-action">
                                {% if req.portal_user_id %}
                                    <a
                                        class="btn-link"
                                        href="{% url 'accounts:trainer_client_detail' req.portal_user_id %}"
                                    >
                                        View
                                    </a>
                                {% else %}
                                    <span>N/A</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="6" class="muted-text">
                                No clients are currently assigned to this trainer.
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if clients_page.has_other_pages %}
            {# Paginator (clients list) #}
            <nav class="pagination-nav" aria-label="Clients pagination">
                <ul class="pagination">
                    {% if clients_page.has_previous %}
                        <li class="pagination-item">
                            <a
                                href="?type={{ client_type }}&page={{ clients_page.previous_page_number }}"
                                class="pagination-link"
                            >
                                &lt; Prev
                            </a>
                        </li>
                    {% endif %}

                    <li class="pagination-item is-active">
                        <span class="pagination-link">
                            Page {{ clients_page.number }} of {{ clients_page.paginator.num_pages }}
                        </span>
                    </li>

                    {% if clients_page.has_next %}
                        <li class="pagination-item">
                            <a
                                href="?type={{ client_type }}&page={{ clients_page.next_page_number }}"
                                class="pagination-link"
                            >
                                Next &gt;
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        {% endif %}
    </div>

    {# Section 2: portal links for client accounts #}
    <div class="dashboard-card">
        <h2 class="dashboard-card__title">Client portal access</h2>
        <p>
            Links below let clients set their portal password even if they missed the email.
        </p>

        <div class="dashboard-table-wrapper">
            <table class="dashboard-table portal-access-table">
                <thead>
                    <tr>
                        <th scope="col" class="col-name">Name</th>
                        <th scope="col" class="col-login">Login username</th>
                        <th scope="col" class="col-portal">Portal access</th>
                        <th scope="col" class="col-link">Password link</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in clients_page %}
                        <tr>
                            <td class="col-name">
                                {% with full_name=req.first_name|add:" "|add:req.last_name %}
                                    {{ full_name|default:req.email }}
                                {% endwith %}
                            </td>
                            <td class="col-login">{{ req.portal_username|default:req.email }}</td>
                            <td class="col-portal">
                                {% if req.portal_access %}
                                    <span class="badge badge--assigned">Yes</span>
                                {% else %}
                                    <span class="badge badge--open">No</span>
                                {% endif %}
                            </td>
                            <td class="col-link">
                                {% if req.portal_user and req.portal_link %}
                                    <div class="portal-link-wrap">
                                        <input
                                            type="text"
                                            class="form-control portal-link-input"
                                            value="{{ req.portal_link }}"
                                            readonly
                                            aria-label="Password reset link"
                                        >
                                        <button
                                            type="button"
                                            class="btn-secondary portal-link-copy"
                                            data-link="{{ req.portal_link }}"
                                            aria-label="Copy password link"
                                        >
                                            Copy
                                        </button>
                                    </div>
                                {% else %}
                                    <span>
                                        Invite link available after account is created.
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="4" class="muted-text">
                                No clients to show.
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if clients_page.has_other_pages %}
            {# Paginator (portal access section) #}
            <nav class="pagination-nav" aria-label="Client portal pagination">
                <ul class="pagination">
                    {% if clients_page.has_previous %}
                        <li class="pagination-item">
                            <a
                                href="?type={{ client_type }}&page={{ clients_page.previous_page_number }}"
                                class="pagination-link"
                            >
                                &lt; Prev
                            </a>
                        </li>
                    {% endif %}

                    <li class="pagination-item is-active">
                        <span class="pagination-link">
                            Page {{ clients_page.number }} of {{ clients_page.paginator.num_pages }}
                        </span>
                    </li>

                    {% if clients_page.has_next %}
                        <li class="pagination-item">
                            <a
                                href="?type={{ client_type }}&page={{ clients_page.next_page_number }}"
                                class="pagination-link"
                            >
                                Next &gt;
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        {% endif %}
    </div>
{% endblock %}

{% block extra_scripts %}
    {{ block.super }}
    <script src="{% static 'js/portal_link_copy.js' %}"></script>
{% endblock %}
